{% extends "index.html" %}
{% block title %}상품 목록{% endblock %}
{% block content %}

<h2 class="page-title">Ewha Market</h2>

<style>
*{ box-sizing: border-box;}

.item-grid-wrapper {
  margin: 0 auto;
  max-width: 1800px;
}

.item-grid {
    display: grid;
    grid-template-columns: repeat(5, minmax(190px, 1fr));
    gap: 10px;
}

.item-card {
    width: 100%;
    padding: 9px;
    text-align: left;
    border: 1px solid #eee;
    background: #fff;
}

.item-card img {
  width: 100%;
  height: 160px;    
  object-fit: cover;  
}
.pager {
    margin-top: 24px;
    margin-bottom: 80px;
}
</style>

<div class="search-bar">
  <form class="search-form" method="GET" action="/list">
    <input type="text" name="q" placeholder="판매자명 또는 상품명 검색" />
    <select name="sort">
      <option value="">정렬 없음</option>
      <option value="price_asc">가격 낮은 순</option>
      <option value="price_desc">가격 높은 순</option>
    </select>
    <button type="submit">검색</button>
  </form>
</div>

{% if total > 0 %}
  <p>{{ total }}개 상품 등록됨</p>
<div class="item-grid-wrapper">
  <div class="item-grid">
    {% for key, value in datas %}
    <div
      class="item-card"
      onclick="location.href='{{ url_for('view_item_detail', name=key) }}';"
      style="cursor:pointer;"
    >
      <img src="static/images/{{ value.img_path }}" />
      <div class="item-info">
        <h3>{{ key }}</h3>
        <p>{{ value.price }}원</p>
        <p>{{ value.addr }}</p>
      </div>
      {# 찜 상태 표시: 로그인했고 내 찜에 있으면 ♥, 아니면 ♡ #}
      {% set liked = (my_wishlist_ids and p.id in my_wishlist_ids) %}
      <button 
        class="like-btn {% if liked %}liked{% endif %}" 
        data-pid="{{ p.id }}" 
        aria-label="찜하기" 
        type="button">
        {% if liked %}♥{% else %}♡{% endif %}
      </button>
    </div>
    {% endfor %}
  </div>
</div>


<div class="pager">
    {# 이전 버튼 #}
    {% if page > 1 %}
      <a href="{{ url_for('view_list', page=page-1) }}" class="page-ctrl" aria-label="이전">&laquo;</a>
    {% else %}
      <span class="page-ctrl" aria-label="이전">&laquo;</span>
    {% endif %}

    <ol class="page-list">
      {% for i in range(1, page_count + 1) %}
        <li class="{% if i == page %}on{% endif %}">
          <a href="{{ url_for('view_list', page=i) }}">{{ i }}</a>
        </li>
      {% endfor %}
    </ol>

    {# 다음 버튼 #}
    {% if page < page_count %}
      <a href="{{ url_for('view_list', page=page+1) }}" class="page-ctrl" aria-label="다음">&raquo;</a>
    {% else %}
      <span class="page-ctrl" aria-label="다음">&raquo;</span>
    {% endif %}
  </div>

<!--추가--!>
<script>
  // 하트 버튼 토글
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.like-btn');
    if (!btn) return;

    const pid = btn.dataset.pid;

    try {
      const res = await fetch(`/toggle_wishlist/${pid}`, { method: 'POST' });
      if (res.status === 401) {
        alert('로그인 해주세요.');
        window.location.href = "{{ url_for('login') }}";
        return;
      }
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || '에러');

      if (data.in_wishlist) {
        btn.classList.add('liked');
        btn.textContent = '♥';
      } else {
        btn.classList.remove('liked');
        btn.textContent = '♡';
      }
    } catch (err) {
      console.error(err);
      alert('오류가 발생했습니다.');
    }
  });
</script>

{% else %}
  <p>등록된 상품이 없습니다.</p>
{% endif %}

{% endblock %}
