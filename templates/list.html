{% extends "index.html" %}
{% block title %}상품 목록{% endblock %}
{% block content %}

<h2 class="page-title">Ewha Market</h2>

<style>
*{ box-sizing: border-box;}

.item-grid-wrapper {
  margin: 0 auto;
  max-width: 1800px;
}

.item-grid {
    display: grid;
    grid-template-columns: repeat(5, minmax(190px, 1fr));
    gap: 10px;
}

.item-card {
    width: 100%;
    padding: 9px;
    text-align: left;
    border: 1px solid #eee;
    background: #fff;
}

.item-card img {
  width: 100%;
  height: 160px;    
  object-fit: cover;  
}
.pager {
    margin-top: 24px;
    margin-bottom: 80px;
}
.heart-icon {
  font-size: 20px;
  cursor: pointer;
  position: absolute;
  top: 10px;
  right: 12px;
}
</style>

<div class="search-bar">
  <form class="search-form" method="GET" action="/list">
    <input type="text" name="q" placeholder="판매자명 또는 상품명 검색" />
    <select name="sort">
      <option value="">정렬 없음</option>
      <option value="price_asc">가격 낮은 순</option>
      <option value="price_desc">가격 높은 순</option>
    </select>
    <button type="submit">검색</button>
  </form>
</div>

{% if total > 0 %}
  <p>{{ total }}개 상품 등록됨</p>
<div class="item-grid-wrapper">
  <div class="item-grid">
    {% for key, value in datas %}
    <div
      class="item-card"
      onclick="location.href='{{ url_for('view_item_detail', name=key) }}';"
      style="cursor:pointer;"
    >
      <img src="static/images/{{ value.img_path }}" />
      <div class="item-info">
        <h3>{{ key }}</h3>
        <p>{{ value.price }}원</p>
        <p>{{ value.addr }}</p>
      </div>
      <!-- 추가 -->
      <i class="fa-heart heart-icon" 
        id="heart-{{ key.id }}" 
        onclick="onHeartClick({{ key }})">
      </i>
    </div>
    {% endfor %}
  </div>
</div>


<div class="pager">
    {# 이전 버튼 #}
    {% if page > 1 %}
      <a href="{{ url_for('view_list', page=page-1) }}" class="page-ctrl" aria-label="이전">&laquo;</a>
    {% else %}
      <span class="page-ctrl" aria-label="이전">&laquo;</span>
    {% endif %}

    <ol class="page-list">
      {% for i in range(1, page_count + 1) %}
        <li class="{% if i == page %}on{% endif %}">
          <a href="{{ url_for('view_list', page=i) }}">{{ i }}</a>
        </li>
      {% endfor %}
    </ol>

    {# 다음 버튼 #}
    {% if page < page_count %}
      <a href="{{ url_for('view_list', page=page+1) }}" class="page-ctrl" aria-label="다음">&raquo;</a>
    {% else %}
      <span class="page-ctrl" aria-label="다음">&raquo;</span>
    {% endif %}
  </div>

{% else %}
  <p>등록된 상품이 없습니다.</p>
{% endif %}

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-latest.min.js"></script>

<script>
// 페이지 로드 시 각 상품의 좋아요 상태 표시
$(document).ready(function() {
    {% for key, value in datas %}
        showHeart("{{ key }}");
    {% endfor %}
});

// 좋아요 상태 불러오기
function showHeart(pid) {
    $.ajax({
        url: "/show_heart/" + pid,
        type: "GET",
        success: function(res) {
            if (res === "Y") {
                $("#heart-" + pid).css("color", "red");
                $("#heart-" + pid).attr("onclick", "unlike('" + pid + "')");
            } else {
                $("#heart-" + pid).css("color", "grey");
                $("#heart-" + pid).attr("onclick", "like('" + pid + "')");
            }
        }
    });
}

// 좋아요 등록
function like(pid) {
    $.ajax({
        url: "/like/" + pid,
        type: "POST",
        success: function() {
            location.reload();
        }
    });
}

// 좋아요 취소
function unlike(pid) {
    $.ajax({
        url: "/unlike/" + pid,
        type: "POST",
        success: function() {
            location.reload();
        }
    });
}

// 클릭 시 호출되는 껍데기 함수
function onHeartClick(pid){}
</script>

{% endblock %}
