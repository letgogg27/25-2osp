{% extends "index.html" %} {% block title %}상품 목록{% endblock %} {% block
content %}

<h2 class="page-title">Ewha Market</h2>

<style>
  * {
    box-sizing: border-box;
  }

  .item-grid-wrapper {
    margin: 0 auto;
    max-width: 1800px;
  }

  .item-grid {
    display: grid;
    grid-template-columns: repeat(5, minmax(190px, 1fr));
    gap: 10px;
  }

  .item-card {
    width: 100%;
    padding: 9px;
    text-align: left;
    border: 1px solid #eee;
    background: #fff;
    border-radius: 10px;
    position: relative;
}

  .item-card img {
    width: 100%;
    height: 160px;
    object-fit: cover;
  }
  .pager {
    margin-top: 24px;
    margin-bottom: 80px;
}
.heart-icon {
  font-size: 22px;
  cursor: pointer;
  position: absolute;
  right: 12px;
  bottom: 12px;
  color: grey;
}
</style>

<div class="search-bar">
  <form class="search-form" method="GET" action="{{ url_for('view_list') }}">
    <input type="text" name="q" placeholder="판매자명 또는 상품명 검색" value="{{ q or '' }}"/>

    <select name="sort" onchange="this.form.submit()">
      <option value="" {% if not sort %}selected{% endif %}>최신순</option>
      <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>가격 낮은 순</option>
      <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>가격 높은 순</option>
    </select>
    <button type="submit">검색</button>
  </form>
</div>

{% if total > 0 %}
<div class="item-grid-wrapper">
  <p class="item-count-text">{{ total }}개 상품 등록됨</p>
    <div class="item-grid">

      {% for key, value in datas %}
      <div class="item-card">
        <!-- 클릭 영역 -->
        <div onclick="location.href='{{ url_for('view_item_detail', name=key) }}'"
            style="cursor:pointer;">
            <img src="static/images/{{ value.img_path }}" />
            <div class="item-info">
                <h3>{{ key }}</h3>
                <p>{{ value.price }}원</p>
                <p>{{ value.addr }}</p>
            </div>
        </div>

        <!-- 하트 -->
        <i class="fa fa-heart heart-icon"
          id="heart-{{ loop.index }}"
          data-name="{{ key }}"
          onclick="onHeartClick(event)"></i>
      </div>
      {% endfor %}
    </div>
</div>


<div class="pager">
  {# 이전 버튼 #} {% if page > 1 %}
  <a
    href="{{ url_for('view_list', page=page-1, q=q, sort=sort) }}"
    class="page-ctrl"
    aria-label="이전"
    >&laquo;</a>
  {% else %}
  <span class="page-ctrl" aria-label="이전">&laquo;</span>
  {% endif %}

  <ol class="page-list">
    {% for i in range(1, page_count + 1) %}
    <li class="{% if i == page %}on{% endif %}">
      <a href="{{ url_for('view_list', page=i, q=q, sort=sort) }}">{{ i }}</a>
    </li>
    {% endfor %}
  </ol>

  {# 다음 버튼 #} {% if page < page_count %}
  <a
    href="{{ url_for('view_list', page=page+1, q=q, sort=sort) }}"
    class="page-ctrl"
    aria-label="다음"
    >&raquo;</a>
  {% else %}
  <span class="page-ctrl" aria-label="다음">&raquo;</span>
  {% endif %}
</div>

{% else %}
<p style="text-align:center; margin-top:50px;">등록된 상품이 없습니다.</p>
{% endif %}

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-latest.min.js"></script>

<script>
$(document).ready(function () {

    {% for key, value in datas %}
        showHeart("heart-{{ loop.index }}", "{{ key }}");
    {% endfor %}
});

/* 좋아요 상태 표시 */
function showHeart(domId, itemName) {

    $.ajax({
        type: 'GET',
        url: '/show_heart/' + itemName + '/',
        success: function (response) {

            let my_heart = response['my_heart'];

            if (my_heart && my_heart['interested'] === 'Y') {
                $("#" + domId).css("color", "red")
                              .attr("onclick", "unlike('" + itemName + "')");
            } else {
                $("#" + domId).css("color", "grey")
                              .attr("onclick", "like('" + itemName + "')");
            }
        },
        error: function(xhr, status, error) {
            console.error("showHeart error:", domId, status, error);
        }
    });
}

/* 좋아요 등록 */
function like(itemName) {

    $.ajax({
        type: 'POST',
        url: '/like/' + itemName + '/',
        data: { interested: "Y" },
        success: function (response) {
            alert(response['msg']);
            window.location.reload();
        }
    });
}

/* 좋아요 취소 */
function unlike(itemName) {

    $.ajax({
        type: 'POST',
        url: '/unlike/' + itemName + '/',
        data: { interested: "N" },
        success: function (response) {
            alert(response['msg']);
            window.location.reload();
        }
    });
}

/* 카드 클릭과 하트 클릭 구분 */
function onHeartClick(event) {
    event.stopPropagation();   
}
</script>


{% endblock %}
