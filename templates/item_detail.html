{% extends "index.html" %} {% block title %}{{ name }} 상세보기{% endblock %} {%
block content %} {# 이미지 목록: img_paths가 있으면 그걸 쓰고, 없으면 기존
img_path 하나만 사용 #} {% set imgs = data.img_paths if data.img_paths is
defined and data.img_paths else [data.img_path] %} {% set price_int =
(data.price|int if data.price is defined and data.price is not none and
data.price != '' else 0) %} {% if data.seller is defined and data.seller %} {%
set seller_initial = data.seller[0]|upper %} {% else %} {% set seller_initial =
'E' %} {% endif %}

<main class="item-details-container">
  <section class="item-summary-box">
    <aside class="item-image-box">
      <div class="main-image-wrapper">
        {% if imgs %}
        <img
          id="main-image"
          src="{{ url_for('static', filename='images/' ~ imgs[0]) }}"
          alt="{{ name }}"
        />
        {% endif %}
      </div>

      {% if imgs|length > 1 %}
      <div class="thumbnail-image-wrapper">
        {% for img in imgs %}
        <div class="thumbnail-image">
          <img
            class="thumb-img"
            src="{{ url_for('static', filename='images/' ~ img) }}"
            data-index="{{ loop.index0 }}"
            alt="{{ name }} {{ loop.index }}"
          />
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </aside>

    <aside class="item-info-container-box">
      <div class="item-title-conditon-box">
        <h2>{{ name }}</h2>
        <small class="item-condition">
          {% if data.status == 'new' %} 새상품(미사용) {% elif data.status ==
          'almost_new' %} 거의 새상품 {% elif data.status == 'used' %} 사용감
          있음 {% else %} 상태 미정 {% endif %}
        </small>
      </div>

      <div class="item-price-box">
        <p class="item-price">{{ "{:,}".format(price_int) }}원</p>
        <div class="item-price-negotiation">
          {% if data.negotiable == 'yes' %} 가격 제안 가능 {% else %} 가격 제안
          불가 {% endif %}
        </div>
      </div>

      <div class="item-seller-info-box">
        <div
          class="seller-thumb-avatar"
          style="
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fee9e7;
            color: #00462a;
            border: 1px solid #00462a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
          "
        >
          {{ seller_initial }}
        </div>

        <div class="item-detail-seller-info">
          <p
            class="item-detail-seller-id"
            style="font-size: 18px; font-weight: 700"
          >
            @ {{data.seller}}
          </p>
          <small class="item-detail-seller-address" style="font-size: 14px">
            <i class="fa-solid fa-star" style="color: #ffc700"></i>평점 4.9 |
            <i class="fa-solid fa-location-dot" style="color: darkred"></i>
            {{data.addr}}
          </small>
        </div>
      </div>

      <div class="item-seller-review">
        <h4>이전 거래 후기</h4>
        <hr />
        <ul class="review-summary">
          <li>
            <div><span>응답이 빨라요</span><strong>4명</strong></div>
          </li>
          <li>
            <div><span>친절해요</span><strong>3명</strong></div>
          </li>
          <li>
            <div><span>상품 상태가 좋아요</span><strong>1명</strong></div>
          </li>
        </ul>
      </div>

      <div class="item-detail-actions-box">
        <button class="item-detail-btn to-chat" id="open-chat-btn">
          채팅하러 가기
        </button>
        <i class="fa fa-heart" id="heart"
           style="font-size:28px; cursor:pointer; margin-left:10px;"></i>
      </div>
    </aside>
  </section>

  <section class="item-detail-explanation-box">
    <div class="detail-header">상품 설명</div>
    <div class="detail-body">
      {# DB에 저장된 description 사용. 줄바꿈을 유지하고 싶으면
      replace('\n','<br />')|safe #} {{ data.description | replace('\n', '<br />')
      | safe }}
    </div>
  </section>

  <!-- Chat modal -->

  <div
    id="chat-modal"
    class="chat-overlay"
    style="display: none"
    data-item-name="{{ name }}"
    data-seller-id="{{ data.seller }}"
    data-current-user-id="{{ session.get('id', '') }}"
  >
    <div class="chat-window">
      <!-- Header -->
      <div class="chat-header">
        <div class="chat-header-left">
          <div class="chat-header-avatar">{{ seller_initial }}</div>
          <div class="chat-header-info">
            <div class="chat-header-name user-id">@{{ data.seller }}</div>
            <div class="chat-header-status">현재 활동 중</div>
          </div>
        </div>
        <button id="close-chat-btn" class="chat-header-close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <!-- Messages area -->
      <div class="chat-body">
        <div class="chat-messages" id="chat-messages">
          <!-- Example receiver message -->
          <div class="message-row receiver">
            <div class="message-avatar receiver">{{ seller_initial }}</div>
            <div class="message-bubble receiver">
              안녕하세요, 상품 아직 구매 가능한가요?
            </div>
          </div>

          <!-- Example sender message -->
          <div class="message-row sender">
            <div class="message-bubble sender">
              네, 가능합니다! 언제쯤 거래 원하세요?
            </div>
            <div class="message-avatar sender">K</div>
          </div>
        </div>
      </div>

      <!-- Input area -->
      <div class="chat-footer">
        <div class="chat-input-wrapper">
          <button type="button" class="chat-icon-btn" id="photo-btn">
            <i class="fa-regular fa-image"></i>
          </button>
          <input
            type="file"
            id="file-input"
            accept="image/*"
            style="display: none"
          />
          <div class="chat-input-container">
            <div id="chat-image-preview"></div>
            <input
              style="border: none"
              id="chat-input"
              type="text"
              class="chat-input"
              placeholder="메시지를 입력하세요..."
            />
          </div>

          <button type="button" class="chat-icon-btn" id="emoji-btn">
            <i class="fa-regular fa-face-smile"></i>
          </button>
        </div>
        <button type="button" id="send-btn" class="chat-send-btn">
          <i class="fa-solid fa-arrow-up"></i>
        </button>
      </div>
    </div>
  </div>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  function showHeart() {
    $.ajax({
      type: 'GET',
      url: '/show_heart/{{name}}/',
      data: {},
      success: function (response) {
        let my_heart = response['my_heart'];

        // 값이 없거나 null이면 기본 상태로 설정
        if (!my_heart || !my_heart['interested']) {
          $("#heart").css("color", "grey");
          $("#heart").attr("onclick", "like()");
          return;
        }

        if (my_heart['interested'] == 'Y') {
          $("#heart").css("color", "red");
          $("#heart").attr("onclick", "unlike()");
        } else {
          $("#heart").css("color", "grey");
          $("#heart").attr("onclick", "like()");
        }
      }
    });
  }

  function like() {
    $.ajax({
      type: 'POST',
      url: '/like/{{name}}/',
      data: { interested: "Y" },
      success: function (response) {
        alert(response['msg']);
        window.location.reload();
      }
    });
  }

  function unlike() {
    $.ajax({
      type: 'POST',
      url: '/unlike/{{name}}/',
      data: { interested: "N" },
      success: function (response) {
        alert(response['msg']);
        window.location.reload();
      }
    });
  }

  $(document).ready(function () {
    showHeart();
  });
</script>

{%endblock%}
