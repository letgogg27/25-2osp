{% extends "index.html" %} {% block title %}{{ name }} 상세보기{% endblock %} {%
block content %} {# 이미지 목록: img_paths가 있으면 그걸 쓰고, 없으면 기존
img_path 하나만 사용 #} {% set imgs = data.img_paths if data.img_paths is
defined and data.img_paths else [data.img_path] %} {% set price_int =
(data.price|int if data.price is defined and data.price is not none and
data.price != '' else 0) %} {% if data.seller is defined and data.seller %} {%
set seller_initial = data.seller[0]|upper %} {% else %} {% set seller_initial =
'E' %} {% endif %}

<main class="item-details-container">
  <section class="item-summary-box">
    <aside class="item-image-box">
      <div class="main-image-wrapper">
        {% if imgs %}
        <img
          id="main-image"
          src="{{ url_for('static', filename='images/' ~ imgs[0]) }}"
          alt="{{ name }}"
        />
        {% endif %}
      </div>

      {% set total_imgs = imgs|length %} {% if total_imgs > 1 %}
      <div class="thumbnail-image-wrapper">
        {% for img in imgs %} {% if total_imgs <= 3 %}
        <div class="thumbnail-image">
          <img
            class="thumb-img"
            src="{{ url_for('static', filename='images/' ~ img) }}"
            data-index="{{ loop.index0 }}"
            alt="{{ name }} {{ loop.index }}"
          />
        </div>

        {% else%} {% if loop.index0 < 2 %}
        <div class="thumbnail-image">
          <img
            class="thumb-img"
            src="{{ url_for('static', filename='images/' ~ img) }}"
            data-index="{{ loop.index0 }}"
            alt="{{ name }} {{ loop.index }}"
          />
        </div>

        {% elif loop.index0 == 2 %}
        <div class="thumbnail-image thumbnail-more">
          <img
            class="thumb-img"
            src="{{ url_for('static', filename='images/' ~ img) }}"
            data-index="{{ loop.index0 }}"
            alt="{{ name }} {{ loop.index }}"
          />
          <div class="thumbnail-overlay">+{{ total_imgs - 3 }}</div>
        </div>
        {% endif %} {% endif %} {% endfor %}
      </div>
      {% endif %}
    </aside>

    <aside class="item-info-container-box">
      {% if session.get('id', '') == data.seller %}
      <div class="item-more-menu">
        <button type="button" class="item-more-btn" id="item-more-btn">
          <i class="fa-solid fa-ellipsis"></i>
        </button>
        <div class="item-more-dropdown" id="item-more-dropdown">
          <button type="button" onclick="deleteItem('{{ name }}')">삭제</button>
          <button type="button" onclick="completeItem('{{ name }}')">
            거래완료
          </button>
        </div>
      </div>
      {% endif %}

      <div class="item-title-conditon-box">
        <h2>{{ name }}</h2>
        <small class="item-condition">
          {% if data.status == 'new' %} 새상품(미사용) {% elif data.status ==
          'almost_new' %} 거의 새상품 {% elif data.status == 'used' %} 사용감
          있음 {% elif data.status == 'sold' %} 거래완료 {% else %} 상태 미정 {%
          endif %}
        </small>
      </div>

      <div class="item-price-box">
        <p class="item-price">{{ "{:,}".format(price_int) }}원</p>
        <div class="item-price-negotiation">
          {% if data.negotiable == 'yes' %} 가격 제안 가능 {% else %} 가격 제안
          불가 {% endif %}
        </div>
      </div>

      <div class="item-seller-info-box">
        <div class="seller-thumb-avatar">
          <div class="profile-img profile-img--seller"></div>
        </div>

        <div class="item-detail-seller-info">
          <p
            class="item-detail-seller-id"
            style="font-size: 18px; font-weight: 700"
          >
            @ {{data.seller}}
          </p>
          <small class="item-detail-seller-address" style="font-size: 14px">
            <i class="fa-solid fa-star" style="color: #ffc700"></i>평점 {{
            review_stats.average_rating | default("0.0") }}|
            <i class="fa-solid fa-location-dot" style="color: darkred"></i>
            {{data.addr}}
          </small>
        </div>
      </div>

      <div class="item-seller-review">
        <h4>이전 거래 후기</h4>
        <hr />
        <ul class="review-summary">
          <li>
            <div><span>응답이 빨라요</span><strong>4명</strong></div>
          </li>
          <li>
            <div><span>친절해요</span><strong>3명</strong></div>
          </li>
          <li>
            <div><span>상품 상태가 좋아요</span><strong>1명</strong></div>
          </li>
        </ul>
      </div>

      <div class="item-detail-actions-box">
        <button class="item-detail-btn to-chat" id="open-chat-btn">
          채팅하러 가기
        </button>
        <button
          class="item-detail-btn to-chat"
          id="reg-riview-btn"
          onclick="location.href='/reg_review_init/{{name}}/';"
        >
          리뷰 등록하기
        </button>
        <button class="item-detail-btn to-wishlist">
          <i id="heart" class="fa fa-heart"></i>
        </button>
      </div>
    </aside>
  </section>

  <section class="item-detail-explanation-box">
    <div class="detail-header">상품 설명</div>
    <div class="detail-body">
      {# DB에 저장된 description 사용. 줄바꿈을 유지하고 싶으면
      replace('\n','<br />')|safe #} {{ data.description | replace('\n', '<br />')
      | safe }}
    </div>
  </section>

  <!-- Chat modal -->

  <div
    id="chat-modal"
    class="chat-overlay"
    style="display: none"
    data-item-name="{{ name }}"
    data-seller-id="{{ data.seller }}"
    data-current-user-id="{{ session['id'] }}"
  >
    <div class="chat-window">
      <!-- Header -->
      <div class="chat-header">
        <div class="chat-header-left">
          <div class="chat-header-avatar">{{ seller_initial }}</div>
          <div class="chat-header-info">
            <div class="chat-header-name user-id">@{{ data.seller }}</div>
            <div class="chat-header-status" id="chat-header-status">
              Loading Status...
            </div>
          </div>
        </div>
        <div
          id="chat-actions"
          style="margin-left: auto; margin-right: 10px"
        ></div>
        <button id="close-chat-btn" class="chat-header-close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <!-- Messages area -->
      <div class="chat-body">
        <div class="chat-messages" id="chat-messages">
          <!-- Example receiver message -->
          <div class="message-row receiver">
            <div class="message-avatar receiver">{{ seller_initial }}</div>
            <div class="message-bubble receiver">
              안녕하세요, 상품 아직 구매 가능한가요?
            </div>
          </div>

          <!-- Example sender message -->
          <div class="message-row sender">
            <div class="message-bubble sender">
              네, 가능합니다! 언제쯤 거래 원하세요?
            </div>
            <div class="message-avatar sender">K</div>
          </div>
        </div>
        <div
          id="typing-indicator"
          style="
            display: none;
            padding: 10px 15px;
            font-size: 14px;
            color: #666;
          "
        >
          <span class="user-id">@{{ data.seller }}</span> is typing<span
            class="typing-dots"
            >...</span
          >
        </div>
      </div>

      <!-- Input area -->
      <div class="chat-footer">
        <div class="chat-input-wrapper">
          <button type="button" class="chat-icon-btn" id="photo-btn">
            <i class="fa-regular fa-image"></i>
          </button>
          <input
            type="file"
            id="file-input"
            accept="image/*"
            style="display: none"
          />
          <div class="chat-input-container">
            <div id="chat-image-preview"></div>
            <input
              style="border: none"
              id="chat-input"
              type="text"
              class="chat-input"
              placeholder="메시지를 입력하세요..."
            />
          </div>
          <!-- 
          <button type="button" class="chat-icon-btn" id="emoji-btn">
            <i class="fa-regular fa-face-smile"></i>
          </button> -->
        </div>
        <button type="button" id="send-btn" class="chat-send-btn">
          <i class="fa-solid fa-arrow-up"></i>
        </button>
      </div>
    </div>
  </div>
  <!-- Image lightbox overlay -->
  <div id="image-lightbox" class="image-lightbox">
    <div class="image-lightbox-inner">
      <button id="lightbox-close">&times;</button>
      <button id="lightbox-prev" class="image-lightbox-btn">&#10094;</button>
      <img
        id="lightbox-img"
        class="image-lightbox-img"
        src=""
        alt="상품 이미지"
      />
      <button id="lightbox-next" class="image-lightbox-btn">&#10095;</button>
    </div>
  </div>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    function showHeart() {
      $.ajax({
        type: "GET",
        url: "/show_heart/{{name}}/",
        data: {},
        success: function (response) {
          let my_heart = response["my_heart"];

          if (!my_heart || !my_heart["interested"]) {
            $("#heart").css("color", "grey");
            $("#heart").attr("onclick", "like()");
            return;
          }

          if (my_heart["interested"] === "Y") {
            $("#heart").css("color", "red");
            $("#heart").attr("onclick", "unlike()");
          } else {
            $("#heart").css("color", "grey");
            $("#heart").attr("onclick", "like()");
          }
        },
      });
    }

    function like() {
      $.ajax({
        type: "POST",
        url: "/like/{{name}}/",
        data: { interested: "Y" },
        success: function (response) {
          alert(response["msg"]);
          window.location.reload();
        },
      });
    }

    function unlike() {
      $.ajax({
        type: "POST",
        url: "/unlike/{{name}}/",
        data: { interested: "N" },
        success: function (response) {
          alert(response["msg"]);
          window.location.reload();
        },
      });
    }

    $(document).ready(function () {
      showHeart();

      // ---------- Image viewer / lightbox ----------
      const imageUrls = [
        {% for img in imgs %}
        "{{ url_for('static', filename='images/' ~ img) }}"{% if not loop.last %},{% endif %}
        {% endfor %}
      ];

      let currentIndex = 0;

      const mainImg = document.getElementById("main-image");
      const thumbImgs = document.querySelectorAll(".thumb-img");

      const lightbox = document.getElementById("image-lightbox");
      const lightboxImg = document.getElementById("lightbox-img");
      const btnPrev = document.getElementById("lightbox-prev");
      const btnNext = document.getElementById("lightbox-next");
      const btnClose = document.getElementById("lightbox-close");

      function updateMainImage(index) {
        if (!mainImg || !imageUrls.length) return;
        currentIndex = index;
        mainImg.src = imageUrls[currentIndex];
      }

      function openLightbox(index) {
        if (!imageUrls.length) return;
        currentIndex = index;
        lightboxImg.src = imageUrls[currentIndex];
        lightbox.style.display = "flex";
      }

      function closeLightbox() {
        lightbox.style.display = "none";
      }

      function showNext() {
        if (!imageUrls.length) return;
        currentIndex = (currentIndex + 1) % imageUrls.length;
        lightboxImg.src = imageUrls[currentIndex];
        updateMainImage(currentIndex);
      }

      function showPrev() {
        if (!imageUrls.length) return;
        currentIndex =
          (currentIndex - 1 + imageUrls.length) % imageUrls.length;
        lightboxImg.src = imageUrls[currentIndex];
        updateMainImage(currentIndex);
      }

      // Main image click -> open lightbox
      if (mainImg) {
        mainImg.style.cursor = "zoom-in";
        mainImg.addEventListener("click", function () {
          openLightbox(currentIndex);
        });
      }

  thumbImgs.forEach((thumb, idx) => {
    thumb.style.cursor = "zoom-in";
    thumb.addEventListener("click", function () {
      openLightbox(idx);
    });
  });

      // Lightbox controls
      if (btnNext) btnNext.addEventListener("click", showNext);
      if (btnPrev) btnPrev.addEventListener("click", showPrev);
      if (btnClose) btnClose.addEventListener("click", closeLightbox);

      // Click outside image closes lightbox
      if (lightbox) {
        lightbox.addEventListener("click", function (e) {
          if (e.target === lightbox) {
            closeLightbox();
          }
        });
      }

      // "ESC" key closes lightbox
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && lightbox.style.display === "flex") {
          closeLightbox();
        }
      });
    });

  document.addEventListener("DOMContentLoaded", function () {
    const moreBtn = document.getElementById("item-more-btn");
    const dropdown = document.getElementById("item-more-dropdown");

    if (!moreBtn || !dropdown) {
      return; // 이 페이지에 메뉴 없으면 그냥 끝
    }

    // 점세개 클릭하면 열기/닫기 토글
    moreBtn.addEventListener("click", function (e) {
      e.stopPropagation(); // 바깥 클릭 이벤트로 바로 닫히는 거 방지
      dropdown.classList.toggle("is-open");
    });

    // 메뉴 안쪽 클릭은 닫히지 않게
    dropdown.addEventListener("click", function (e) {
      e.stopPropagation();
    });

    // 화면 아무 데나 클릭하면 닫기
    document.addEventListener("click", function () {
      dropdown.classList.remove("is-open");
    });
  });
</script>

{%endblock%}
